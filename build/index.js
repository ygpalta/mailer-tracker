(()=>{var t={672:(t,e,n)=>{const o=n(860),s=n(582),a=(n(470),n(17)),i=(n(872),n(528)),r=(n(781),o());r.use(s()),r.use(o.json()),r.use(o.urlencoded({extended:!0})),r.use(o.static(a.join(__dirname,"..","public"))),r.use("/api",i),r.get("/*",((t,e)=>{e.sendFile(a.join(__dirname,"..","public","index.html"))})),t.exports=r},769:(t,e,n)=>{const o=n(837),s=n(738),{v4:a}=n(828);let i=n(17),r=s.diskStorage({destination:(t,e,n)=>{n(null,__basedir+"/assets/uploads")},filename:(t,e,n)=>{console.log(e.originalname),n(null,e.originalname+"-"+a()+"-"+Date.now()+i.extname(e.originalname))}}),l=s({storage:r}).single("attachment"),c=s({storage:r}).fields([{name:"attachment",maxCount:1},{name:"csv",maxCount:1}]),d=o.promisify(l),u=o.promisify(c);t.exports={uploadAttachmentMiddleware:d,uploadFilesMiddleware:u}},563:(t,e,n)=>{const o=n(264);t.exports={getAllMails:async function(){return await o.find({},{_id:0,__v:0})},getClicked:async function(){return await o.find({clicked:!0})},getTrained:async function(){return await o.find({training_completed:!0})},saveMail:async function(t){return await o.findOneAndUpdate({id:t.id},t,{upsert:!0})},setClicked:async function(t){console.log(t.id);const e=await o.find({id:t.id,clicked:!1});if(console.log(e),console.log("Clicked length: "+e.length),1==e.length){console.log("Changing");var n=(new Date).setSeconds(0,0);return await o.findOneAndUpdate({id:t.id},{clicked:!0,clicked_date:n}),!0}return console.log("No Change"),!1},setTrained:async function(t){const e=await o.find({id:t.id,training_completed:!1});if(console.log(e),console.log("trained length: "+e.length),1==e.length){console.log("trained");var n=(new Date).setSeconds(0,0);return await o.findOneAndUpdate({id:t.id},{training_completed:!0,training_date:n}),!0}return console.log("No Change"),!1},deleteAllMails:async function(){return console.log("Deleting all mails"),await o.deleteMany({}).then(console.log("All Mails deleted")),!0}}},264:(t,e,n)=>{const o=n(185),s=new o.Schema({id:{type:"String"},sender_email:{type:"String"},sender_name:{type:"String"},from:{type:"String"},recipient_email:{type:"String"},sent_date:{type:"Date"},subject:{type:"String"},message:{type:"String"},attachment:{type:"String"},clicked:{type:"Boolean",default:"false"},clicked_date:{type:"Date"},training_completed:{type:"Boolean",default:"false"},training_date:{type:"Date"}});t.exports=o.model("SentMails",s)},372:(t,e,n)=>{const o=n(682);t.exports={getSettings:async function(t){return await o.find({poweredby:"Apptriangle"})},updateSettings:async function(t){return console.log("updating settigs:",t),await o.findOneAndUpdate({poweredby:"Apptriangle"},{smtp_setup:{host:t.host,port:t.port,tls:t.tls,authentication:t.authentication,userName:t.userName,password:t.password}})},updateClientName:async function(t){return await o.findOneAndUpdate({poweredby:"Apptriangle"},t)},updateSentCounter:async function(){return await o.findOneAndUpdate({poweredby:"Apptriangle"},{$inc:{total_sent:1}})},updateClickedCounter:async function(){return await o.findOneAndUpdate({poweredby:"Apptriangle"},{$inc:{total_clicked:1}})},updateTrainedCounter:async function(){return await o.findOneAndUpdate({poweredby:"Apptriangle"},{$inc:{total_trained:1}})},resetCounter:async function(){return console.log("Resetting Counter"),await o.findOneAndUpdate({poweredby:"Apptriangle"},{total_sent:0,total_clicked:0,total_trained:0}).then(console.log("Counter Reset to 0")),!0}}},682:(t,e,n)=>{const o=n(185),s=new o.Schema({clientName:{type:"String"},smtp_setup:{host:{type:"String"},port:{type:"Number"},tls:{type:"Boolean",default:"false"},authentication:{type:"Boolean",default:"false"},userName:{type:"String"},password:{type:"String"}},total_sent:{type:"Number",default:0},total_clicked:{type:"Number",default:0},total_trained:{type:"Number",default:0},poweredby:{type:"String",default:"Apptriangle"}});t.exports=o.model("Settings",s)},872:(t,e,n)=>{const o=n(860),s=n(24),a=n(781),i=n(102),r=o.Router();function l(t,e,n){n()}r.use("/login",s),r.use("/settings",l,a),r.use("/sentMails",l,i),t.exports=r},528:(t,e,n)=>{const o=n(860),s=n(872),a=n(788),i=o.Router();i.use("/admin",s),i.use("/landingPage",a);const r=n(738),{v4:l}=n(828),c=r.diskStorage({destination:function(t,e,n){n(null,"images")},filename:function(t,e,n){n(null,l()+"-"+Date.now()+path.extname(e.originalname))}});let d=r({storage:c,fileFilter:(t,e,n)=>{["image/jpeg","image/jpg","image/png"].includes(e.mimetype)?n(null,!0):n(null,!1)}});i.route("/add").post(d.single("attachment"),((t,e)=>{console.log("files:",t.file),console.log("body files:",t.body);const n={name:t.body.name,from:t.body.from,attachment:t.files.attachment.name};console.log("Data:",n),e.status(200).json({Msg:"File uploaded"})})),t.exports=i},574:(t,e,n)=>{const{setClicked:o,setTrained:s}=n(563),{getSettings:a,updateClickedCounter:i,updateTrainedCounter:r}=n(372);t.exports={httpGetClientName:async function(t,e){console.log(t.body);const n=await a("Apptriangle");return e.status(200).json({clientName:n[0].clientName})},httpSetClicked:async function(t,e){console.log(t.body);const n=await o(t.body);return console.log("Updated: "+n),n?(console.log("Changing Counter"),await i(),e.status(200).json({updated:!0})):e.status(200).json({updated:!1})},httpSetTrained:async function(t,e){console.log(t.body);const n=await s(t.body);return console.log("Updated: "+n),n?(console.log("Changing Counter"),await r(),e.status(200).json({updated:!0})):e.status(200).json({updated:!1})}}},788:(t,e,n)=>{const o=n(860),{httpGetClientName:s,httpSetClicked:a,httpSetTrained:i}=n(574),r=o.Router();r.get("/",s),r.post("/",a),r.post("/trained",i),t.exports=r},493:(t,e,n)=>{n(142).config();const o=n(344),s=process.env.USER,a=process.env.PASSWORD,i=process.env.TOKEN_KEY;t.exports={httpLogin:async function(t,e){if(t.body.token)try{const n=o.verify(t.body.token,i);return t.user=n,e.status(200).json(n)}catch(t){return console.log(t),e.status(401).send("Invalid Token")}try{if(t.body.user===s&&t.body.password===a){const n=o.sign({user:t.body.user},i,{expiresIn:"1h"});e.status(200).json({login:!0,token:n})}else e.status(401).json({Message:"Invalid Credentials"})}catch(t){console.log(t),e.status(401).json({err:t})}}}},24:(t,e,n)=>{const o=n(860),{httpLogin:s}=n(493),a=o.Router();a.post("/",s),t.exports=a},172:(t,e,n)=>{const{getAllMails:o,getClicked:s,getTrained:a,saveMail:i,setClicked:r,setTrained:l}=n(563),{getSettings:c,updateSentCounter:d}=n(372),{sendMail:u}=n(463),p=n(184),{uploadAttachmentMiddleware:g,uploadFilesMiddleware:m}=n(769),{v4:y}=(n(860).Router(),n(738),n(828)),f=n(147);n(17);const{parse:h}=n(187);t.exports={httpGetAllMails:async function(t,e){return e.status(200).json(await o())},httpGetClicked:async function(t,e){return e.status(200).json(await s())},httpGetTrained:async function(t,e){return e.status(200).json(await a())},httpSendMail:async function(t,e){await m(t,e);const n=t.body,o=await c("Apptriangle");let s=await p.createTransport({host:o[0].smtp_setup.host,port:o[0].smtp_setup.port,secure:!1,auth:{user:o[0].smtp_setup.userName,pass:o[0].smtp_setup.password}}),a=[];async function r(){for(let e=0;e<a.length;e++){console.log("Sending mail to:",a[e]);let o=Date.now(),r=n.html.split("landingPage").join(`landingPage/${o}`);console.log(r);let l={from:n.name+" <"+n.address+">",to:a[e],subject:n.subject,html:r};null!=t.files.attachment&&(l.attachments=[{filename:t.files.attachment[0].originalname,path:t.files.attachment[0].path}]),await s.sendMail(l),await i({from:l.from,recipient_email:l.to,subject:l.subject,message:r,sent_date:new Date(Date.now()),id:o,clicked:!1,traintraining_completed:!1}),await d()}return e.sendStatus(201)}await async function(){"true"==n.bulk&&null!=t.files.csv?f.createReadStream(t.files.csv[0].path).pipe(h({columns:!0,skip_empty_lines:!0,bom:!0,delimiter:",",ltrim:!0})).on("data",(function(t){a.push(t.email)})).on("error",(function(t){console.log(t.message)})).on("end",(function(){console.log(a),r()})):(a=n.to.split(","),r())}()},httpSetClicked:async function(t,e){const n=await r(t.body.id);return e.status(201).json(n)},httpSetTrained:async function(t,e){const n=await l(t.body.id);return e.status(201).json(n)}}},102:(t,e,n)=>{const o=n(860),{httpGetAllMails:s,httpGetClicked:a,httpGetTrained:i,httpSendMail:r,httpSetClicked:l,httpSetTrained:c}=n(172),d=o.Router();d.get("/",s),d.get("/getClicked",a),d.get("/getTrained",i),d.post("/new",r),t.exports=d},753:(t,e,n)=>{const{getSettings:o,updateSettings:s,updateClientName:a,resetCounter:i}=n(372),{deleteAllMails:r}=n(563),{createTransporter:l}=n(463),c=n(184);t.exports={httpGetSettings:async function(t,e){const n=await o("Apptriangle");return e.status(200).json(n[0])},httpUpdateSettings:async function(t,e){console.log("trying new: ",t.body);let n={host:t.body.host,port:t.body.port};"false"==t.body.tls&&(n.tls={rejectUnauthorized:!1}),"true"==t.body.authentication&&(n.auth={user:t.body.userName,pass:t.body.password}),console.log("Trying: ",n),(await c.createTransport(n)).verify((async function(n,o){return n?(console.log(n),console.log("err"),e.status(400).json({yo:"error"})):(console.log("success"),await s(t.body),e.sendStatus(200))}))},httpUpdateClientName:async function(t,e){return console.log("new name:",t.body),e.status(200).json(await a(t.body))},httpResetMailbox:async function(t,e){console.log("Resetting Mailbox:");const n=await i(),o=await r();return n&&o?e.status(200).json({reset:!0}):e.status(500).json({reset:!1})}}},781:(t,e,n)=>{const o=n(860),{httpGetSettings:s,httpUpdateSettings:a,httpUpdateClientName:i,httpResetMailbox:r}=n(753),l=o.Router();l.get("/",s),l.post("/",a),l.post("/updateLandingPage",i),l.post("/resetMailbox",r),t.exports=l},945:(t,e,n)=>{const o=n(185);n(142).config();const s=process.env.MONGO_URL;o.connection.once("open",(()=>{console.log("Mongo DB Connection Ready")})),o.connection.on("error",(t=>{console.error(t)})),t.exports={mongoConnect:async function(){console.log("COnnecting"),await o.connect(s),console.log("Connected")},mongoDisconnect:async function(){await o.disconnect()}}},463:(t,e,n)=>{const{getSettings:o}=n(372),s=n(184),{Error:a}=n(185);t.exports={createTransporter:async function(t){let e=await s.createTransport(t);return e.verify((function(t,n){return t?(console.log(t),!1):(console.log(e),console.log("Success"),e)}))},sendMail:async function(t){const e=await o("Apptriangle");console.log("Settings:",e[0].smtp_setup),(await s.createTransport(e[0].smtp_setup)).verify((function(t,e){t?(console.log(t),console.log("err")):console.log("success")}))}}},582:t=>{"use strict";t.exports=require("cors")},187:t=>{"use strict";t.exports=require("csv-parse")},142:t=>{"use strict";t.exports=require("dotenv")},860:t=>{"use strict";t.exports=require("express")},344:t=>{"use strict";t.exports=require("jsonwebtoken")},185:t=>{"use strict";t.exports=require("mongoose")},470:t=>{"use strict";t.exports=require("morgan")},738:t=>{"use strict";t.exports=require("multer")},184:t=>{"use strict";t.exports=require("nodemailer")},828:t=>{"use strict";t.exports=require("uuid")},147:t=>{"use strict";t.exports=require("fs")},685:t=>{"use strict";t.exports=require("http")},17:t=>{"use strict";t.exports=require("path")},837:t=>{"use strict";t.exports=require("util")}},e={};function n(o){var s=e[o];if(void 0!==s)return s.exports;var a=e[o]={exports:{}};return t[o](a,a.exports,n),a.exports}(()=>{n(142).config();const t=process.env.PORT||8e3;global.__basedir=__dirname;const e=n(685),o=n(672),{mongoConnect:s}=n(945),a=e.createServer(o);n(184),async function(){await s(),a.listen(t,(()=>{console.log(`Listening on port ${t}...`)}))}()})()})();
//# sourceMappingURL=index.js.map